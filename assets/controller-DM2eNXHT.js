var m=Object.defineProperty;var u=(o,t,s)=>t in o?m(o,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[t]=s;var e=(o,t,s)=>(u(o,typeof t!="symbol"?t+"":t,s),s);import{M as p,a as n,b as i,v as f}from"./Mqtt-BvJzmVve.js";import{m as b}from"./mqtt-_JQTHONO.js";import{H as h}from"./hammerjs-CuQLBY46.js";import"./ammo.js-BpglqV0R.js";const y="8884/mqtt",G="wss",g="broker.hivemq.com",w=30;class P{constructor(){e(this,"axisOrientation",-1);e(this,"isOrientationFixed",!1);e(this,"x");e(this,"y");e(this,"clientId");e(this,"isStarted",!1);e(this,"isFinished",!1);e(this,"isJoined",!1);e(this,"joinGameButton",null);e(this,"startGameButton",null);e(this,"resetGameButton",null);e(this,"playerNameInput",null);e(this,"dropButton",null);e(this,"errorPane",null);e(this,"preGameController",null);e(this,"gameController",null);e(this,"mqtt");e(this,"mc");this.x=0,this.y=0;let t="";const a=new URLSearchParams(window.location.search).get("session");a!==null&&(t=a),this.clientId=btoa(new Date().getTime().toString()).slice(-9).substring(0,7),this.mqtt=new p(b.connect(`${G}://${g}:${y}`),!1,t),this.mqtt.subscribe(this.mqtt.eventToClientTopic(n.ControllerMessage,i.All,this.clientId)),this.mqtt.subscribe(this.mqtt.eventToClientTopic(n.ControllerMessage,i.All,this.mqtt.broadcast)),setInterval(()=>this.broadcastUpdate(),w),this.loadElementsFromDOM()}loadElementsFromDOM(){var s,a,r,c,l;this.joinGameButton=document.getElementById("join-game-button"),this.startGameButton=document.getElementById("start-game-button"),this.resetGameButton=document.getElementById("reset-game-button"),this.playerNameInput=document.getElementById("player-name"),this.errorPane=document.getElementById("error"),this.preGameController=document.getElementById("setup-grid"),this.gameController=document.getElementById("game-grid");let t=document.getElementById("swipe-area");if(t!==null){this.mc=new h.Manager(t);let d=new h.Swipe;this.mc.add(d),this.setSwipeGesturesDependingOnOrientation()}this.dropButton=document.getElementById("drop"),(s=this.dropButton)==null||s.addEventListener("click",()=>this.activatePayload()),(a=this.gameController)==null||a.remove(),(r=this.joinGameButton)==null||r.addEventListener("click",()=>this.checkPermissions()),(c=this.startGameButton)==null||c.addEventListener("click",()=>this.broadcastStartGame()),(l=this.resetGameButton)==null||l.addEventListener("click",()=>this.broadcastResetGame()),screen.orientation.addEventListener("change",()=>this.setSwipeGesturesDependingOnOrientation()),window.addEventListener("resize",()=>this.setSwipeGesturesDependingOnOrientation())}setError(t){this.errorPane!==null&&(this.errorPane.innerText=t)}clearError(){this.errorPane!==null&&(this.errorPane.innerText="")}setSwipeGesturesDependingOnOrientation(){this.mc!==void 0&&(this.mc.off("swipeup"),this.mc.off("swipedown"),this.mc.off("swipeleft"),this.mc.off("swiperight"),window.matchMedia("(orientation: portrait)").matches&&(this.mc.on("swipedown",()=>this.broadcastRotatePayloadLeft()),this.mc.on("swipeup",()=>this.broadcastRotatePayloadRight()),this.mc.on("swipeleft",()=>this.broadcastScalePayloadUp()),this.mc.on("swiperight",()=>this.broadcastScalePayloadDown())),window.matchMedia("(orientation: landscape)").matches&&(this.mc.on("swipeleft",()=>this.broadcastRotatePayloadLeft()),this.mc.on("swiperight",()=>this.broadcastRotatePayloadRight()),this.mc.on("swipeup",()=>this.broadcastScalePayloadUp()),this.mc.on("swipedown",()=>this.broadcastScalePayloadDown())))}broadcastJoinGame(){let t="anonymous";this.playerNameInput!==null&&this.playerNameInput.value!==""&&(t=this.playerNameInput.value),this.mqtt.publishClientSpecific(n.PlayerAction,i.Init,this.clientId,t),this.mqtt.on("message",(s,a)=>{const r=a.toString(),[c,l]=this.mqtt.parseTopic(s);switch(l){case i.ColorResponse:this.acknowledgeGameJoined(),this.setColor(r);break;case i.Start:this.startGame();break;case i.Stop:this.stopGame();break;case i.Reset:this.resetGame(),this.clearError();break;case i.GameFullResponse:this.setError("The maximum number of players is reached!");break}})}broadcastStartGame(){!this.isStarted&&this.isJoined&&this.mqtt.publishClientSpecific(n.PlayerAction,i.Start,this.mqtt.broadcast,"")}broadcastUpdate(){!this.isFinished&&this.isJoined&&this.mqtt.publishClientSpecific(n.PlayerAction,i.Movement,this.clientId,f(this.y,0,this.x))}broadcastResetGame(){this.isFinished&&this.mqtt.publishClientSpecific(n.PlayerAction,i.Reset,this.clientId,"")}broadcastRotatePayloadLeft(){this.mqtt.publishClientSpecific(n.PlayerAction,i.RotatePayload,this.clientId,"-1")}broadcastRotatePayloadRight(){this.mqtt.publishClientSpecific(n.PlayerAction,i.RotatePayload,this.clientId,"+1")}broadcastScalePayloadUp(){this.mqtt.publishClientSpecific(n.PlayerAction,i.Scale,this.clientId,"+0.1")}broadcastScalePayloadDown(){this.mqtt.publishClientSpecific(n.PlayerAction,i.Scale,this.clientId,"-0.1")}setColor(t){document.body.style.setProperty("--player-color",t)}initEventListener(){window.addEventListener("devicemotion",t=>{t.accelerationIncludingGravity!==null&&t.accelerationIncludingGravity.x!==null&&t.accelerationIncludingGravity.y!==null&&(this.x=this.axisOrientation*t.accelerationIncludingGravity.x,this.y=this.axisOrientation*t.accelerationIncludingGravity.y)},!0)}activatePayload(){this.mqtt.publishClientSpecific(n.PlayerAction,i.Drop,this.clientId,"")}disableJoin(){this.joinGameButton!==null&&this.joinGameButton.classList.add("disabled")}enableJoin(){this.joinGameButton!==null&&this.joinGameButton.classList.remove("disabled")}disableStart(){this.startGameButton!==null&&this.startGameButton.classList.add("disabled")}enableStart(){this.startGameButton!==null&&this.startGameButton.classList.remove("disabled")}disableReset(){this.resetGameButton!==null&&this.resetGameButton.classList.add("disabled")}enableReset(){this.resetGameButton!==null&&this.resetGameButton.classList.remove("disabled")}switchToGameUi(){var t;(t=this.preGameController)==null||t.remove(),this.gameController!==null&&document.body.append(this.gameController)}switchToSetupUi(){var t;(t=this.gameController)==null||t.remove(),this.preGameController!==null&&document.body.append(this.preGameController)}acknowledgeGameJoined(){this.isJoined=!0,this.disableJoin(),this.isStarted?(this.switchToGameUi(),this.disableStart()):this.enableStart()}joinGame(){this.initEventListener(),this.clearError(),this.broadcastJoinGame()}startGame(){this.isStarted=!0,this.isJoined&&(this.switchToGameUi(),this.disableStart())}stopGame(){this.isFinished=!0,this.switchToSetupUi(),this.enableReset(),this.setColor("#ffffff")}resetGame(){this.isStarted=!1,this.isFinished=!1,this.isJoined=!1,this.enableJoin(),this.disableReset()}checkPermissions(){if(!this.isJoined)if(typeof DeviceMotionEvent<"u"){const t=DeviceOrientationEvent.requestPermission;typeof t=="function"?t().then(a=>{a==="granted"?(this.joinGame(),this.isOrientationFixed||(this.axisOrientation*=-1,this.isOrientationFixed=!0)):this.setError("You need to allow the usage of acceleration data!")}).catch(a=>{this.setError(a)}):this.joinGame()}else this.joinGame()}}new P;
