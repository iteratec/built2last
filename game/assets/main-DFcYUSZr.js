var ot=Object.defineProperty;var nt=(o,t,e)=>t in o?ot(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var i=(o,t,e)=>(nt(o,typeof t!="symbol"?t+"":t,e),e);import{M as ht,a as A,b,m as lt}from"./Mqtt-BvJzmVve.js";import{m as ct}from"./mqtt-_JQTHONO.js";import{a as tt}from"./ammo.js-BpglqV0R.js";import{M as F,V as u,B as dt,a as gt,T as B,N as U,R as D,b as W,D as et,S as ut,c as mt,P as it,G as J,C as pt,d as yt,e as bt,f as ft,g as wt,h as St,W as Pt,i as Mt,j as vt,k as Ct,A as xt,l as It}from"./three-DcUpSQvA.js";import{t as kt}from"./qrcode-9l5oT34S.js";import"./encode-utf8-Cn5aGd7v.js";import"./dijkstrajs-D_NXgYpA.js";const P=class P{constructor(){}static init(){return tt.bind(window)()}static initAuxObjects(){P.auxVector3=new P.Ammo.btVector3(0,0,0),P.auxTransform=new P.Ammo.btTransform}static destroyAuxObjects(){P.Ammo.destroy(P.auxTransform),P.Ammo.destroy(P.auxVector3)}};i(P,"Ammo"),i(P,"auxVector3"),i(P,"auxTransform");let n=P;function st(o){const t=o.getMass(),e=o.getPosition(),s=o.getQuaternion(),r=o.getAabb(),a=o.getScale(),l=o.getId(),c=o.getFriction(),w=.05;n.auxTransform.setIdentity(),n.auxVector3.setValue(e.x,e.y,e.z),n.auxTransform.setOrigin(n.auxVector3);let f=new n.Ammo.btQuaternion(s.x,s.y,s.z,s.w);n.auxTransform.setRotation(f),n.auxVector3.setValue(r.x/2,r.y/2,r.z/2);let M=new n.Ammo.btBoxShape(n.auxVector3);M.setMargin(w);let v=new n.Ammo.btVector3(0,0,0);M.calculateLocalInertia(t,v),n.auxVector3.setValue(a,a,a),M.setLocalScaling(n.auxVector3);let g=new n.Ammo.btDefaultMotionState(n.auxTransform),I=new n.Ammo.btRigidBodyConstructionInfo(t,g,M,v);I.m_friction=c;let k=new n.Ammo.btRigidBody(I);return k.setUserIndex(l),n.Ammo.destroy(I),n.Ammo.destroy(v),n.Ammo.destroy(f),k}function At(o){let t=o.getMotionState(),e=o.getCollisionShape();n.Ammo.destroy(o),n.Ammo.destroy(t),n.Ammo.destroy(e)}function rt(o,t){let e=t.getMotionState();if(e){e.getWorldTransform(n.auxTransform);let s=n.auxTransform.getOrigin(),r=n.auxTransform.getRotation();o.position.set(s.x(),s.y(),s.z()),o.quaternion.set(r.x(),r.y(),r.z(),r.w()),o.children.forEach(a=>{rt(a,t),a.position.set(s.x(),s.y(),s.z()),a.quaternion.set(r.x(),r.y(),r.z(),r.w())})}}const Dt=.4,Rt=2.5;class L{constructor(t,e,s=1,r=1,a=.5,l=16777215){i(this,"position");i(this,"size");i(this,"mass");i(this,"friction");i(this,"color");i(this,"id");i(this,"scalingFactor",1);i(this,"isPhysicsEnabled",!1);i(this,"isDestructible",!1);i(this,"mesh",new F);i(this,"rigidBody");this.position=t.clone(),this.size=s,this.mass=r,this.friction=a,this.color=l,this.id=e}addPhysics(t){return this.isPhysicsEnabled?!1:(this.rigidBody=t,this.isPhysicsEnabled=!0,!0)}isAffectedByPhysics(){return this.isPhysicsEnabled}getFriction(){return this.friction}update(){!this.isAffectedByPhysics()||this.rigidBody===void 0||(rt(this.mesh,this.rigidBody),this.position.copy(this.mesh.position))}getRigidBody(){return this.rigidBody}setPosition(t){if(this.position.copy(t),this.mesh.position.copy(t),this.isAffectedByPhysics())throw"setPosition: objects with enabled physics cannot be repositioned"}getPosition(){return this.position.clone()}setColor(t){this.color=t,this.mesh.material.color.setHex(t)}getColor(){return this.color}getMesh(){return this.mesh}translateX(t){this.position.add(new u(t,0,0)),this.mesh.translateX(t)}translateY(t){this.position.add(new u(0,t,0)),this.mesh.translateY(t)}translateZ(t){this.position.add(new u(0,0,t)),this.mesh.translateZ(t)}scale(t){this.scalingFactor+t>Rt||this.scalingFactor+t<Dt||(this.scalingFactor+=t,this.mesh.scale.set(this.scalingFactor,this.scalingFactor,this.scalingFactor),this.isAffectedByPhysics()&&this.rigidBody!==void 0&&(n.auxVector3.setValue(this.scalingFactor,this.scalingFactor,this.scalingFactor),this.rigidBody.getCollisionShape().setLocalScaling(n.auxVector3),this.rigidBody.activate()))}getScale(){return this.scalingFactor}getMass(){return this.mass}getAabb(){return new u(this.size,this.size,this.size)}getQuaternion(){return this.mesh.quaternion}setQuaternion(t){if(this.mesh.quaternion.copy(t),this.isAffectedByPhysics())throw"setQuaternion: objects with enabled physics cannot be repositioned"}delete(){this.mesh.material.dispose(),this.mesh.geometry.dispose(),this.isAffectedByPhysics()&&this.rigidBody!==void 0&&At(this.rigidBody)}getId(){return this.id}getIsDestructible(){return this.isDestructible}setIsDestructible(t){this.isDestructible=t}}const C=class C extends L{static init(t,e,s){C.boxFriction=t,C.boxSize=e,C.boxMass=s}constructor(t,e,s=C.boxSize,r=C.boxMass,a=C.boxFriction,l=16777215){super(t,e,s,r,a,l);const c=new dt(this.size,this.size,this.size),w=new gt({color:this.color});this.mesh=new F(c,w),this.mesh.position.copy(this.position),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0}setIsDestructible(t){if(t===!1)throw"setIsDestructible: destructability of Box cannot be turned off"}getIsDestructible(){return!0}};i(C,"boxFriction"),i(C,"boxSize"),i(C,"boxMass");let T=C;const h=class h extends L{static init(t,e,s,r,a,l){h.orbFriction=t,h.orbMass=e,h.orbSegments=s,h.orbFrequency=r,h.orbSize=a,h.orbColor=l,h.displacement=new B().load("orb.png"),h.displacement.magFilter=U,h.displacement.wrapT=D,h.displacement.wrapS=D,h.displacement.repeat.y=1,h.displacement.repeat.x=1,h.alpha=new B().load("orb.png"),h.alpha.magFilter=U,h.alpha.wrapT=D,h.alpha.wrapS=D,h.alpha.repeat.y=3,h.alpha.repeat.x=3,h.emissive=new B().load("orb.png"),h.emissive.magFilter=U,h.emissive.wrapT=D,h.emissive.wrapS=D,h.emissive.repeat.y=4,h.emissive.repeat.x=4,h.material=new W({color:h.orbColor,displacementMap:h.displacement,displacementScale:1,alphaMap:h.alpha,transparent:!0,side:et,emissive:16777215,emissiveIntensity:1,emissiveMap:h.emissive,roughness:1}),h.geometry=new ut(h.orbSize,h.orbSegments,h.orbSegments)}static cleanup(){h.material.dispose(),h.geometry.dispose(),h.alpha.dispose(),h.displacement.dispose()}static staticUpdate(){h.displacement.offset.y+=.5*h.orbFrequency,h.alpha.offset.y+=h.orbFrequency,h.emissive.offset.y+=h.orbFrequency}constructor(t,e,s=h.orbSize){super(t,e,s,h.orbMass,h.orbFriction,h.orbColor),this.mesh=new F(h.geometry,h.material),this.scalingFactor=s/h.orbSize,this.mesh.scale.set(this.scalingFactor,this.scalingFactor,this.scalingFactor),this.mesh.castShadow=!0,this.mesh.position.copy(this.position)}delete(){}scale(){}addPhysics(t){return!1}setIsDestructible(t){if(t===!0)throw"setIsDescructible: orb cannot be marked as indesctructible"}};i(h,"displacement"),i(h,"alpha"),i(h,"emissive"),i(h,"material"),i(h,"geometry"),i(h,"orbFriction"),i(h,"orbMass"),i(h,"orbSegments"),i(h,"orbFrequency"),i(h,"orbSize"),i(h,"orbColor");let R=h;const d=class d extends L{constructor(e,s,r,a,l=d.raySize){super(e,s,l,d.rayMass,d.rayFriction,r);i(this,"targetPositionFn");this.mesh=new F(d.geometry,d.material),this.scalingFactor=l/d.raySize,this.mesh.scale.set(this.scalingFactor,this.scalingFactor,this.scalingFactor),this.mesh.position.copy(this.position),this.targetPositionFn=a}static init(e,s,r){d.raySize=e,d.rayMass=r,d.rayFriction=s;const a=d.generateRayTexture();d.alpha=new B().load("alpha.png"),d.texture=new mt(a),d.texture.needsUpdate=!0,d.alpha.magFilter=U,d.alpha.wrapT=D,d.alpha.repeat.y=2,d.material=new W({map:d.texture,color:16777215,side:et,transparent:!0,opacity:1,alphaMap:d.alpha}),d.geometry=new it(1,e)}update(){this.mesh.lookAt(this.targetPositionFn())}static staticUpdate(){d.alpha.offset.y+=Math.random()*.05}delete(){}static cleanUp(){d.material.dispose(),d.geometry.dispose(),d.texture.dispose(),d.alpha.dispose()}addPhysics(e){return!1}setIsDestructible(e){if(e===!0)throw"setIsDescructible: ray cannot be marked as indesctructible"}scale(e){}static generateRayTexture(){let e=document.createElement("canvas"),s=e.getContext("2d");if(e.width=64,e.height=1,s===null)return e;let r=s.createLinearGradient(0,0,e.width,e.height);return r.addColorStop(0,"rgba(0, 0, 0, 0.1)"),r.addColorStop(.1,"rgba(255, 0, 0, 0.4"),r.addColorStop(.5,"rgba(255, 0, 0, 1.0"),r.addColorStop(.9,"rgba(255, 0, 0, 0.4"),r.addColorStop(1,"rgba(0, 0, 0, 0.1)"),s.fillStyle=r,s.fillRect(0,0,e.width,e.height),e}};i(d,"rayFriction"),i(d,"rayMass"),i(d,"raySize"),i(d,"material"),i(d,"texture"),i(d,"alpha"),i(d,"geometry");let O=d;var q=(o=>(o[o.Box=0]="Box",o[o.HealthCheck=1]="HealthCheck",o[o.DeletetionRay=2]="DeletetionRay",o))(q||{});function Ot(o){return(o+1)%(Object.keys(q).length/2)}function Tt(o){return(o-1>=0?o-1:Object.keys(q).length/2-1)%(Object.keys(q).length/2)}function Z(o,t){const e=o.getPosition(),s=t.generateId();switch(o.getPayloadType()){case 0:{const r=new T(e,s);return t.add(r),new K(r,t)}case 1:{const r=new R(e,s);return t.add(r),new Ft(r,t)}case 2:{const r=new O(o.getIndicatorPosition(),s,16711680,()=>t.getCameraPosition());return t.add(r),new jt(r,t)}default:{const r=new T(e,s);return t.add(r),new K(r,t)}}}class K{constructor(t,e){i(this,"payload");i(this,"environment");this.payload=t,this.environment=e}activate(){let t=st(this.payload);this.payload.addPhysics(t),this.environment.addPhysicsObject(t)}isPermanent(){return!0}getRepresentation(){return this.payload}}class Ft{constructor(t,e){i(this,"payload");i(this,"environment");this.payload=t,this.environment=e}activate(){this.environment.startEarthquake(),this.environment.remove(this.payload),this.payload.delete()}isPermanent(){return!1}getRepresentation(){return this.payload}}class jt{constructor(t,e){i(this,"payload");i(this,"environment");this.payload=t,this.environment=e}activate(){let t=this.payload.getPosition();t.setY(-100);let e=this.environment.rayHitObject(this.payload.getPosition(),t);e!==void 0&&e.getIsDestructible()&&(this.environment.remove(e),e.delete()),this.environment.remove(this.payload),this.payload.delete()}isPermanent(){return!1}getRepresentation(){return this.payload}}class V{constructor(t,e){i(this,"duration");i(this,"lastUpdateTime");i(this,"remainingMs");i(this,"isTimerRunning",!1);i(this,"events",{});i(this,"callbackFn");this.duration=t,this.remainingMs=t,this.lastUpdateTime=new Date().getTime(),this.callbackFn=e}update(){if(!this.isTimerRunning)return;let t=new Date().getTime();this.remainingMs=this.remainingMs-(t-this.lastUpdateTime),Object.keys(this.events).forEach(e=>{let s=Number.parseInt(e);s<this.getElapsed()&&(this.events[s](),delete this.events[s])}),this.remainingMs<0&&(this.isTimerRunning=!1,this.remainingMs=0,this.callbackFn()),this.lastUpdateTime=t}on(t,e){if(Object.keys(this.events).includes(t.toString())){const s=this.events[t];this.events[t]=()=>{s(),e()}}else this.events[t]=e}getRemaining(){return this.remainingMs}getElapsed(){return this.duration-this.remainingMs}start(){this.isTimerRunning||(this.lastUpdateTime=new Date().getTime(),this.isTimerRunning=!0)}isRunning(){return this.isTimerRunning}pause(){this.isTimerRunning=!1}reset(){this.isTimerRunning||(this.events={},this.remainingMs=this.duration,this.lastUpdateTime=new Date().getTime())}}const zt="panel",Lt="panel-parent";class N{constructor(t,e=Lt){i(this,"target");i(this,"parent");i(this,"isHidden",!0);this.target=document.createElement("div"),this.target.id=t,this.target.classList.add(zt);let s=document.getElementById(e);s!==null?this.parent=s:this.parent=document.body}show(){this.isHidden&&this.parent.append(this.target),this.isHidden=!1}hide(){this.isHidden||this.parent.removeChild(this.target),this.isHidden=!0}render(){}}class Et extends N{constructor(t,e,s,r,a){super(t,a);let l=document.createElement("h2"),c=document.createElement("p");this.target.classList.add("tutorial-container"),l.innerText=s,c.innerText=r,this.target.append(l),this.target.append(c),kt(e,{width:256},(w,f)=>{w||(f.style.removeProperty("height"),f.style.removeProperty("width"),this.target.append(f))})}}const $=new u(0,70,0);class S{constructor(t,e){i(this,"hasRenderObject");i(this,"text");i(this,"renderObject");this.text=t,this.renderObject=e,this.hasRenderObject=this.renderObject!==void 0}}class Bt{constructor(t,e,s,r="",a){i(this,"timer");i(this,"tutorialEnvironment");i(this,"idProviderFn");i(this,"panelContext");i(this,"tutorialObjects",[]);i(this,"currentObjectIndex",0);i(this,"isShown",!1);i(this,"gameUrl");this.timer=new V(t,()=>this.rotate()),this.idProviderFn=s,this.tutorialEnvironment=e,this.gameUrl=r,this.panelContext=a,this.createSettingsText(),this.createIntroText(),this.createRotationInfo(),this.createJoinInfo(),this.createMovementInfo(),this.createGoalInfo(),this.createDropInfo(),this.createScaleInfo(),this.createRotateInfo(),this.createMutableBoxInfo(),this.createImmutableBoxInfo(),this.createHealthcheckInfo(),this.createDeletionInfo()}createPanel(t,e,s){const r=this.panelContext.getParentId();return new Et(t,this.gameUrl,e,s,r)}createSettingsText(){let t=this.createPanel("settings-tutorial","Settings","On the device that is displaying this page, press 1, 2 or 3 to set the difficulty to easy, medium or hard. Press + or - to increase or decrease the game clock."),e=new S(t);this.tutorialObjects.push(e)}createIntroText(){let t=this.createPanel("connect-tutorial","Connect","Scan the QR Code with your phone to connect to the game."),e=new S(t);this.tutorialObjects.push(e)}createRotationInfo(){let t=this.createPanel("rotate-tutorial","Rotate","To use your phone as a controller, rotate it such that the charging port points to the left. You may want to lock automatic screen rotation."),e=new S(t);this.tutorialObjects.push(e)}createJoinInfo(){let t=this.createPanel("join-tutorial","Join","On your phone, enter a name and join. The new background color is the color of your avatar."),e=new S(t);this.tutorialObjects.push(e)}createMovementInfo(){let t=this.createPanel("move-tutorial","Move","Tilt your phone to move your avatar."),e=new S(t);this.tutorialObjects.push(e)}createGoalInfo(){let t=this.createPanel("goal-tutorial","Goal","Build the highest tower in your designated area."),e=new S(t);this.tutorialObjects.push(e)}createDropInfo(){let t=this.createPanel("build-tutorial","Build","After the game is started, click in the left half of your controller to drop your payload."),e=new S(t);this.tutorialObjects.push(e)}createScaleInfo(){let t=this.createPanel("scale-tutorial","Scale","After the game is started, swipe in the right area of your controller up or down to scale your payload."),e=new S(t);this.tutorialObjects.push(e)}createRotateInfo(){let t=this.createPanel("switch-tutorial","Switch","After the game is started, swipe in the right area of your controller  left or right to switch your payload."),e=new S(t);this.tutorialObjects.push(e)}createMutableBoxInfo(){let t=this.createPanel("mutability-tutorial","Mutability","Those boxes are mutable, they will scale up and down after being dropped."),e=new T($,this.idProviderFn(),20,0,0,65280),s=new S(t,e);this.tutorialObjects.push(s)}createImmutableBoxInfo(){let t=this.createPanel("immutability-tutorial","Immutability","Those boxes are immutable, they won't scale up and down after being dropped."),e=new T($,this.idProviderFn(),20,0,0,16711680),s=new S(t,e);this.tutorialObjects.push(s)}createHealthcheckInfo(){let t=this.createPanel("health-tutorial","Health Check","This payload triggers a health check of all towers if dropped."),e=new R($,this.idProviderFn(),20),s=new S(t,e);this.tutorialObjects.push(s)}createDeletionInfo(){let t=this.createPanel("delete-tutorial","Delete","Use this payload to delete undesired boxes."),e=new u(0,20,20),s=new O($,this.idProviderFn(),16711680,()=>e,40),r=new S(t,s);this.tutorialObjects.push(r)}rotate(){if(!this.isShown)return;this.timer.reset(),this.timer.start();let t=this.tutorialObjects[this.currentObjectIndex];t.renderObject!==void 0&&this.tutorialEnvironment.remove(t.renderObject),t.text.hide(),this.panelContext.remove(t.text),this.currentObjectIndex=(this.currentObjectIndex+1)%this.tutorialObjects.length;let e=this.tutorialObjects[this.currentObjectIndex];e.renderObject!==void 0&&this.tutorialEnvironment.add(e.renderObject),e.text.show(),this.panelContext.add(e.text)}update(){this.timer.update()}cleanUp(){this.tutorialObjects.forEach(t=>{t.renderObject!==void 0&&t.renderObject.delete()})}show(){if(this.isShown)return;this.isShown=!0,this.currentObjectIndex=0;let t=this.tutorialObjects[this.currentObjectIndex];t.renderObject!==void 0&&this.tutorialEnvironment.add(t.renderObject),t.text.show(),this.panelContext.add(t.text),this.timer.reset(),this.timer.start()}hide(){if(!this.isShown)return;this.isShown=!1;let t=this.tutorialObjects[this.currentObjectIndex];t.renderObject!==void 0&&this.tutorialEnvironment.remove(t.renderObject),t.text.hide(),this.panelContext.remove(t.text),this.timer.pause()}}const Ut="counter";class Ht extends N{constructor(e,s,r){super(e,r);i(this,"timeSupplier");this.timeSupplier=s,this.target.classList.add(Ut)}pad(e,s){let r=e.toString();for(;r.length<s;)r="0"+r;return r}render(){const e=this.timeSupplier(),s=Math.floor(e/1e3),r=Math.floor(s/60),a=s%60,l=e%1e3;this.target.innerHTML=`${this.pad(r,2)}:${this.pad(a,2)}:${this.pad(l,3)}`}}const qt="game-over";class Vt extends N{constructor(e,s,r){super(e,r);i(this,"heading");i(this,"message");i(this,"winner");i(this,"winnerSupplier");i(this,"highscore",0);i(this,"name","");this.target.classList.add(qt),this.heading=document.createElement("h2"),this.heading.innerText="Game over!",this.message=document.createElement("span"),this.target.replaceChildren(this.heading),this.target.append(this.message),this.winnerSupplier=s}render(){this.winner===void 0&&(this.winner=this.winnerSupplier(),this.highscore=this.winner.getHighscore(),this.name=this.winner.getName()),this.message.innerText=`${this.name} won with ${this.highscore} points!`}}const Gt="highscore";class Wt extends N{constructor(e,s,r){super(e,r);i(this,"heading");i(this,"highscoreSupplier");this.target.classList.add(Gt),this.heading=document.createElement("h2"),this.heading.innerHTML="Ranking",this.highscoreSupplier=s}render(){const e=this.highscoreSupplier();let s=document.createElement("ol");e.sort((r,a)=>a.getHighscore()-r.getHighscore()),e.forEach(r=>{let a=document.createElement("li");a.innerText=`${r.getName()} - ${Math.round(r.getHighscore()).toString()}`,s.append(a)}),this.target.replaceChildren(s),this.target.insertBefore(this.heading,s)}}const Nt="overlay";class $t extends N{constructor(e,s,r){super(e,r);i(this,"message","");i(this,"timer");this.timer=new V(s,()=>this.hide()),this.target.classList.add(Nt)}setMessage(e){this.message=e}show(){super.show(),this.timer.start()}hide(){super.hide(),this.timer.pause(),this.timer.reset()}render(){this.timer.update(),this.target.innerHTML=this.message}}class Yt{constructor(t){i(this,"panels");i(this,"renderInterval");i(this,"lastRender");this.lastRender=new Date().getTime(),this.panels=[],this.renderInterval=t}render(){new Date().getTime()<=this.lastRender+this.renderInterval||(this.panels.forEach(t=>t.render()),this.lastRender=new Date().getTime())}add(t){this.panels.push(t)}remove(t){this.panels=this.panels.filter(e=>t!=e)}}const j="game-ui";class Xt{constructor(t,e,s,r){i(this,"timer");i(this,"panels");i(this,"overlay");i(this,"gameOverDisplay");this.timer=t;let a=document.createElement("div");a.id=j,a.classList.add("game-grid"),document.body.append(a),this.panels=new Yt(s);let l=new Wt("highscore",e,j);l.show(),this.panels.add(l);let c=new Ht("countdown",()=>this.timer.getRemaining(),j);c.show(),this.panels.add(c),this.overlay=new $t("overlay",r,j),this.panels.add(this.overlay)}getParentId(){return j}add(t){this.panels.add(t)}remove(t){this.panels.remove(t)}render(){this.panels.render()}showGameOverScreen(t){this.gameOverDisplay=new Vt("game-over",()=>t,j),this.gameOverDisplay.show(),this.panels.add(this.gameOverDisplay)}showPopup(t){this.overlay.setMessage(t),this.overlay.show()}reset(){this.gameOverDisplay!==void 0&&(this.gameOverDisplay.hide(),this.panels.remove(this.gameOverDisplay)),this.overlay.hide()}}const x=class x extends L{constructor(e,s,r=150){super(e,s,r,x.bedrockMass,x.bedrockFriction);i(this,"grid",new J);const a=new it(this.size,this.size);a.rotateX(-Math.PI/2);const l=new W({color:this.color,opacity:1}),c=new F(a,l);c.position.copy(this.position),c.receiveShadow=!0,this.grid=new J(this.size,x.gridSegments),this.grid.position.copy(this.position),this.grid.material.transparent=!0,this.mesh=c,this.mesh.children.push(this.grid)}static init(e,s,r){x.bedrockFriction=e,x.bedrockMass=s,x.gridSegments=r}delete(){this.grid.dispose(),super.delete()}getIsDestructible(){return!1}getAabb(){return new u(this.size,0,this.size)}};i(x,"bedrockFriction"),i(x,"bedrockMass"),i(x,"gridSegments");let X=x;const E=5,_=10,m=class m extends L{constructor(e,s,r,a,l){super(e,a,2*E,0,0,s);i(this,"rayEnvironment");i(this,"currentScore",0);i(this,"material");i(this,"heightScaling",1);i(this,"name","");i(this,"bedrockDepth",0);this.rayEnvironment=r,this.bedrockDepth=l,this.material=new W({color:s,transparent:!0,opacity:.7,side:yt,alphaMap:m.alpha}),this.mesh=new F(m.geometry,this.material),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.mesh.position.copy(this.position)}static init(e,s){m.radius=e,m.height=s,m.geometry=new pt(m.radius,m.radius,m.height,32,32,!0),m.alpha=new B().load("area.png"),m.alpha.magFilter=U,m.alpha.wrapS=D,m.alpha.repeat.y=1,m.alpha.repeat.x=3}setName(e){this.name=e}getName(){return this.name}delete(){this.material.dispose()}static cleanUp(){m.geometry.dispose(),m.alpha.dispose()}isAffectedByPhysics(){return!1}static staticUpdate(){}update(){this.heightScaling=Math.sin(new Date().getTime()*.001)*.3+1,this.mesh.position.set(this.position.x,this.position.y+_*this.heightScaling/2,this.position.z),this.mesh.scale.set(1,this.heightScaling,1);const e=1e3;let s=[E,0,-E],r=[];for(let l=0;l<s.length;l++)for(let c=0;c<s.length;c++)r.push(this.rayEnvironment.rayDistance(new u(this.position.x+s[l],e,this.position.z+s[c]),new u(this.position.x+s[l],-100,this.position.z+s[c])));const a=Math.min(...r.filter(l=>l>=0));e+this.bedrockDepth-a<0?this.currentScore=0:this.currentScore=e+this.bedrockDepth-a}setPosition(e){this.position.copy(e),this.mesh.position.set(this.position.x,this.position.y+_*this.heightScaling/2,this.position.z)}addPhysics(){return!1}getAabb(){return new u(E*2,_,E*2)}getHighscore(){return Math.round(this.currentScore)}getIsDestructible(){return!1}};i(m,"radius"),i(m,"height"),i(m,"geometry"),i(m,"alpha");let H=m;class Y{constructor(t,e){i(this,"lastUpdateElapsed");i(this,"unit");i(this,"timer");this.unit=t/e,this.lastUpdateElapsed=0,this.timer=new V(e,()=>{})}start(){this.timer.start()}isRunning(){return this.timer.isRunning()}pause(){this.timer.pause()}getDeltaStep(){if(!this.timer.isRunning())return 0;this.timer.update();let t=this.timer.getElapsed();const e=(t-this.lastUpdateElapsed)*this.unit;return this.lastUpdateElapsed=t,e}}const p=class p extends L{constructor(e,s,r){super(e,r,1,0,0,s);i(this,"xAnimation");i(this,"yAnimation");i(this,"zAnimation");i(this,"yTarget");i(this,"payload");i(this,"payloadType",q.Box);i(this,"isPayloadMutable",!1);i(this,"isLocked");i(this,"mutableObjects",{});i(this,"immutableObjects",{});i(this,"material");this.isLocked=!1,this.yTarget=this.position.y,this.material=new W({color:s}),this.mesh=new F(p.geometry,this.material),this.mesh.position.copy(this.getOffsetPosition()),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0}static init(e,s,r,a){p.indicatorOffset=e,p.mutableColor=s,p.immutableColor=r,p.geometry=new bt,p.animationDurationMs=a}getOffsetPosition(){let e=this.position.clone(),s=p.indicatorOffset+Math.sin(new Date().getTime()*.005)*.5;return e.setY(e.y+s),e}getIndicatorPosition(){return this.getOffsetPosition()}setPayload(e,s){this.payload=e,this.isPayloadMutable=s,e.isPermanent()&&(s?e.getRepresentation().setColor(p.mutableColor):e.getRepresentation().setColor(p.immutableColor))}getPayloadType(){return this.payloadType}setPayloadType(e){this.payloadType=e}clearPayload(){this.payload=void 0,this.isPayloadMutable=!1}setPosition(e){var s;this.xAnimation!==void 0&&(this.xAnimation.pause(),this.xAnimation=void 0),this.yAnimation!==void 0&&(this.yAnimation.pause(),this.yAnimation=void 0),this.zAnimation!==void 0&&(this.zAnimation.pause(),this.zAnimation=void 0),super.setPosition(e),this.mesh.position.copy(this.getOffsetPosition()),(s=this.payload)==null||s.getRepresentation().setPosition(e),this.yTarget=this.position.y}getPayload(){return this.payload}getPointsForHeightTest(){let e=[];if(this.payload!==void 0){let s=new ft;s.setFromObject(this.payload.getRepresentation().getMesh());const r=s.min,a=s.max;e.push(r),e.push(new u(r.x,r.y,a.z)),e.push(new u(a.x,r.y,r.z)),e.push(new u(a.x,r.y,a.z))}return e.push(this.position),e}releasePayload(){var s;if(this.isLocked=!0,this.payload===void 0||!this.payload.isPermanent())return this.payload;const e=this.payload;return this.isPayloadMutable?this.mutableObjects[this.payload.getRepresentation().getId()]=this.payload:this.immutableObjects[this.payload.getRepresentation().getId()]=this.payload,(s=this.payload)==null||s.getRepresentation().setColor(this.color),this.payload=void 0,this.isPayloadMutable=!1,e}lock(){this.isLocked=!0}unlock(){this.isLocked=!1}getIsLocked(){return this.isLocked}isAffectedByPhysics(){return!1}update(){var l;let e=0,s=0,r=0;this.xAnimation!=null&&(e=this.xAnimation.getDeltaStep(),this.xAnimation.isRunning()||(this.xAnimation=void 0)),this.yAnimation!=null&&(s=this.yAnimation.getDeltaStep(),this.yAnimation.isRunning()||(this.yAnimation=void 0)),this.zAnimation!=null&&(r=this.zAnimation.getDeltaStep(),this.zAnimation.isRunning()||(this.zAnimation=void 0));const a=new u(e,s,r);this.position.add(a),this.mesh.position.copy(this.getOffsetPosition()),(l=this.payload)==null||l.getRepresentation().setPosition(this.position)}getAabb(){var s;let e=(s=this.payload)==null?void 0:s.getRepresentation().getAabb();return e!==void 0?(e==null||e.add(new u(0,p.indicatorOffset,0)),e):new u(0,0,0)}addPhysics(){return!1}removePotentialChild(e){Object.keys(this.immutableObjects).includes(e)&&delete this.immutableObjects[e],Object.keys(this.mutableObjects).includes(e)&&delete this.mutableObjects[e]}scalePayload(e,s){var r,a;Object.values(this.mutableObjects).forEach(l=>{const c=l.getRepresentation();c.scale(e),c.isAffectedByPhysics()&&s(c.getRigidBody())}),(r=this.payload)==null||r.getRepresentation().scale(e),(a=this.payload)!=null&&a.getRepresentation().isAffectedByPhysics()&&s(this.payload.getRepresentation().getRigidBody())}translateX(e){this.xAnimation!=null&&this.xAnimation.pause(),this.xAnimation=new Y(e,p.animationDurationMs),this.xAnimation.start()}translateY(e){this.yAnimation!=null&&this.yAnimation.pause(),this.yAnimation=new Y(e,p.animationDurationMs),this.yAnimation.start()}translateZ(e){this.zAnimation!=null&&this.zAnimation.pause(),this.zAnimation=new Y(e,p.animationDurationMs),this.zAnimation.start()}moveToTargetHeight(e){Math.abs(this.yTarget-e)<.005||(this.yTarget=e,this.translateY(this.yTarget-this.position.y))}delete(){var e;(e=this.payload)==null||e.getRepresentation().delete(),this.material.dispose()}static cleanUp(){p.geometry.dispose()}getIsDestructible(){return!1}setIsDestructible(e){throw"setIsDestructible: Players cannot be destructed"}};i(p,"geometry"),i(p,"indicatorOffset"),i(p,"mutableColor"),i(p,"immutableColor"),i(p,"animationDurationMs");let G=p;const z=class z{constructor(t,e,s,r,a){i(this,"cooldownUntil",{});i(this,"highscores",{});i(this,"players",{});i(this,"resetTimer");i(this,"timer");i(this,"tutorial");i(this,"ui");i(this,"world");i(this,"config");i(this,"playerConstructor");i(this,"stopCallback");i(this,"resetCallback");this.config=a,z.isInitialized||(R.init(this.config.orbFriction,this.config.orbMass,this.config.orbSegments,this.config.orbFrequency,this.config.orbSize,this.config.orbColor),O.init(this.config.raySize,this.config.rayFriction,this.config.rayMass),H.init(this.config.highscoreRadius,this.config.highscoreHeight),G.init(this.config.gamePlayerIndicatorOffset,this.config.gameMutablePayloadColor,this.config.gameImmutablePayloadColor,this.config.gamePlayerAnimationDurationMs),X.init(this.config.bedrockFriction,this.config.bedrockMass,this.config.bedrockGridSegments),T.init(this.config.boxFriction,this.config.boxSize,this.config.boxMass),z.isInitialized=!0),this.world=r(),this.timer=new V(a.gameDurationMs,()=>this.stop()),this.resetTimer=new V(a.resetDurationMs,()=>this.reset()),this.ui=new Xt(this.timer,()=>Object.values(this.highscores),this.config.uiRefreshMs,this.config.uiPopupDurationMs),this.tutorial=new Bt(this.config.tutorialShowItemMs,this.world,()=>this.world.generateId(),this.config.gameUrl,this.ui),this.tutorial.show(),this.playerConstructor=t,this.stopCallback=e,this.resetCallback=s,this.setupStaticEvents(),this.ui.showPopup(`Difficulty: ${this.config.difficulty}`)}isNewObjectMutable(){return Math.random()<this.config.gameMutablePayloadProbability}setupStaticEvents(){this.timer.on(6e4,()=>this.triggerHealtCheck()),this.timer.on(12e4,()=>this.triggerHealtCheck()),this.timer.on(this.config.gameDurationMs-3e4,()=>this.triggerDisruption())}triggerHealtCheck(){this.world.startEarthquake(),this.ui.showPopup("Health Check!")}triggerDisruption(){this.world.startRotation(),this.ui.showPopup("Disruption!")}start(){this.timer.start(),this.tutorial.hide()}stop(){this.ui.showGameOverScreen(Object.values(this.highscores).sort((t,e)=>e.getHighscore()-t.getHighscore())[0]),this.timer.pause(),this.stopCallback(),this.resetTimer.start()}reset(){this.timer.isRunning()||(this.players={},this.highscores={},this.cooldownUntil={},this.resetTimer.pause(),this.resetTimer.reset(),this.timer.reset(),this.ui.reset(),this.world.reset(),this.setupStaticEvents(),this.resetCallback(),this.tutorial.show())}isRunning(){return this.timer.isRunning()}isPlayerAddable(){return Object.keys(this.players).length<this.config.gameMaxPlayers}addPlayer(t,e){if(!this.isPlayerAddable())return-1;const s=Object.keys(this.players).length,r=this.playerConstructor(0,0,0,this.config.gameStartColors[s],this.world.generateId());this.players[t]=r,this.world.add(r),this.world.addPlayer(r);const a=Z(r,this.world);r.setPayload(a,this.isNewObjectMutable());const l=new H(new u(this.config.gameStartPositions[s][0],this.config.bedrockDepth,this.config.gameStartPositions[s][1]),this.config.gameStartColors[s],this.world,this.world.generateId(),-this.config.bedrockDepth);return l.setName(e),this.world.add(l),this.highscores[t]=l,this.cooldownUntil[t]=new Date().getTime(),this.config.gameStartColors[s]}switchPlayerPayload(t,e){if(t!=""&&this.hasPlayer(t)){const s=this.players[t];if(s.getIsLocked())return;let r=s.getPayload();r!==void 0&&(this.world.remove(r.getRepresentation()),r.getRepresentation().delete()),e>0?s.setPayloadType(Ot(s.getPayloadType())):s.setPayloadType(Tt(s.getPayloadType()));let a=Z(s,this.world);s.setPayload(a,this.isNewObjectMutable())}}hasPlayer(t){return Object.keys(this.players).includes(t)}getPlayer(t){return this.players[t]}activatePayload(t){if(this.isRunning()&&t!=""&&Object.keys(this.players).includes(t)){const e=this.players[t];if(e.getIsLocked())return;const s=e.releasePayload();s==null||s.activate(),e.lock(),this.cooldownUntil[t]=new Date().getTime()+this.config.gameCooldownMs}}updateCooldowns(){const t=new Date().getTime();Object.keys(this.cooldownUntil).forEach(e=>{if(this.cooldownUntil[e]<=t&&this.players[e].getIsLocked()){this.players[e].unlock();const s=Z(this.players[e],this.world);this.players[e].setPayload(s,this.isNewObjectMutable())}})}update(){this.timer.update(),this.resetTimer.update(),R.staticUpdate(),O.staticUpdate(),this.updateCooldowns(),this.world.update(),this.tutorial.update()}render(){this.world.render(),this.ui.render()}cleanUp(){this.tutorial.cleanUp(),R.cleanup(),O.cleanUp(),H.cleanUp(),G.cleanUp(),z.isInitialized=!1}scalePlayer(t,e){this.isRunning()&&(t!=""&&Object.keys(this.players).includes(t)&&this.players[t].scalePayload(e,s=>this.world.updateRigidBody(s)),this.world.activateAllObjects())}};i(z,"isInitialized",!1);let Q=z;class Zt{constructor(t){i(this,"bedrock");i(this,"camera");i(this,"clock");i(this,"constraints",[]);i(this,"currentId",0);i(this,"light");i(this,"objectCounter",0);i(this,"objects",{});i(this,"physicsUniverse",{});i(this,"players",[]);i(this,"renderer");i(this,"scene");i(this,"sceneRotationMovement");i(this,"worldConstructionInfo");this.worldConstructionInfo=t,this.camera=new wt(this.worldConstructionInfo.cameraFov,window.innerWidth/window.innerHeight,this.worldConstructionInfo.cameraNearPlane,this.worldConstructionInfo.cameraFarPlane),this.scene=new St,this.renderer=new Pt({antialias:!0}),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=Mt,this.clock=new vt,this.initGraphicsUniverse(),this.initPhysicsUniverse(),this.initBedrock()}destroyObjects(){this.constraints.forEach(t=>{this.physicsUniverse.removeConstraint(t),n.Ammo.destroy(t)}),this.constraints=[],Object.keys(this.objects).forEach(t=>{let e=this.objects[t];e.delete(),this.remove(e)})}reset(){this.destroyObjects(),this.scene.quaternion.set(0,0,0,1),this.sceneRotationMovement=void 0,this.currentId=0,this.initBedrock()}getCameraPosition(){let t=new u;return this.camera.getWorldPosition(t),t}generateId(){let t=this.currentId;return this.currentId++,t}initBedrock(){this.bedrock=new X(new u(0,this.worldConstructionInfo.bedrockDepth,0),this.generateId(),this.worldConstructionInfo.bedrockSize),this.bedrock.addPhysics(st(this.bedrock)),this.add(this.bedrock);const t=this.worldConstructionInfo.bedrockSize/2,e=this.worldConstructionInfo.bedrockSize/2-this.worldConstructionInfo.bedrockSpringDistanceToCorner,s=[-t,-t,+t,+t,+e,-e,+e,-e],r=[-e,+e,-e,+e,-t,-t,+t,+t],a=new n.Ammo.btVector3(1,0,1),l=new n.Ammo.btVector3(0,0,0),f=[0,2];for(let M=0;M<s.length;M++){let v=n.auxTransform;v.setIdentity(),v.setOrigin(new n.Ammo.btVector3(s[M],0,r[M]));let g=new n.Ammo.btGeneric6DofSpringConstraint(this.bedrock.getRigidBody(),v,!1);g.setLinearLowerLimit(a),g.setLinearUpperLimit(l),f.forEach(I=>{g.enableSpring(I,!0),g.setStiffness(I,this.worldConstructionInfo.bedrockSpringStiffness),g.setDamping(I,this.worldConstructionInfo.bedrockSpringDamping)}),g.setEquilibriumPoint(),this.constraints.push(g),this.physicsUniverse.addConstraint(g,!1)}n.Ammo.destroy(a),n.Ammo.destroy(l)}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}initGraphicsUniverse(){this.camera.position.copy(this.worldConstructionInfo.cameraPosition),this.camera.lookAt(0,0,0),this.scene.background=new Ct(this.worldConstructionInfo.rendererBackgroundColor),this.scene.add(new xt(this.worldConstructionInfo.rendererMainLightColor)),this.light=new It(this.worldConstructionInfo.rendererMainLightColor,this.worldConstructionInfo.rendererMainLightIntensity),this.light.position.copy(this.worldConstructionInfo.rendererMainLightPosition),this.light.castShadow=this.worldConstructionInfo.rendererMainLightCastShadows,this.light.shadow.camera.near=this.worldConstructionInfo.rendererMainLightShadowNearPlane,this.light.shadow.camera.far=this.worldConstructionInfo.rendererMainLightShadowFarPlane,this.light.shadow.camera.top=this.worldConstructionInfo.bedrockSize/2,this.light.shadow.camera.left=-this.worldConstructionInfo.bedrockSize/2,this.light.shadow.camera.bottom=-this.worldConstructionInfo.bedrockSize/2,this.light.shadow.camera.right=this.worldConstructionInfo.bedrockSize/2,this.light.shadow.bias=this.worldConstructionInfo.rendererMainLightShadowBias,this.light.shadow.mapSize.width=this.worldConstructionInfo.rendererMainLightShadowResolution,this.light.shadow.mapSize.height=this.worldConstructionInfo.rendererMainLightShadowResolution,this.scene.add(this.light),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth-this.worldConstructionInfo.rendererWindowSpacing,window.innerHeight-this.worldConstructionInfo.rendererWindowSpacing),this.renderer.shadowMap.enabled=!0,document.body.appendChild(this.renderer.domElement),window.addEventListener("resize",()=>this.onWindowResize())}initPhysicsUniverse(){let t=new n.Ammo.btDefaultCollisionConfiguration,e=new n.Ammo.btCollisionDispatcher(t),s=new n.Ammo.btDbvtBroadphase,r=new n.Ammo.btSequentialImpulseConstraintSolver;this.physicsUniverse=new n.Ammo.btDiscreteDynamicsWorld(e,s,r,t),n.auxVector3.setValue(0,this.worldConstructionInfo.physicsGravity,0),this.physicsUniverse.setGravity(n.auxVector3)}startEarthquake(){var s;let t=this.worldConstructionInfo.physicsEarthquakeStrength*this.objectCounter,e=(s=this.bedrock)==null?void 0:s.getRigidBody();e!==void 0&&(e.activate(),e.applyCentralImpulse(new n.Ammo.btVector3(t,0,0)),e.applyCentralImpulse(new n.Ammo.btVector3(0,0,t)))}update(){this.physicsUniverse.stepSimulation(this.clock.getDelta(),this.worldConstructionInfo.physicsEngineSubsteps),Object.values(this.objects).forEach(t=>{t.update()}),this.sceneRotationMovement!==void 0&&this.sceneRotationMovement.isRunning()&&this.scene.rotateY(this.sceneRotationMovement.getDeltaStep()),this.adjustPlayerHeights()}render(){this.renderer.render(this.scene,this.camera)}startRotation(){this.sceneRotationMovement=new Y(this.worldConstructionInfo.gameRotationAmount,this.worldConstructionInfo.gameRotationDurationMs),this.sceneRotationMovement.start()}adjustPlayerHeights(){let t=new n.Ammo.btVector3(0,0,0),e=new n.Ammo.btVector3(0,0,0);this.players.forEach(s=>{let a=s.getPointsForHeightTest().map(l=>{t.setValue(l.x,this.worldConstructionInfo.gamePlayerMaxHeight,l.z),e.setValue(l.x,this.worldConstructionInfo.gamePlayerMinHeight,l.z);let c=new n.Ammo.ClosestRayResultCallback(t,e);this.physicsUniverse.rayTest(t,e,c);let w=0;return c.hasHit()&&(w=c.get_m_hitPointWorld().y()+this.worldConstructionInfo.gamePlayerOffset),n.Ammo.destroy(c),w});s.moveToTargetHeight(Math.max(...a))}),n.Ammo.destroy(t),n.Ammo.destroy(e)}rayDistance(t,e){let s=-1,r=new n.Ammo.btVector3(t.x,t.y,t.z),a=new n.Ammo.btVector3(e.x,e.y,e.z),l=new n.Ammo.ClosestRayResultCallback(r,a);return this.physicsUniverse.rayTest(r,a,l),l.hasHit()&&(s=t.distanceTo(new u(l.get_m_hitPointWorld().x(),l.get_m_hitPointWorld().y(),l.get_m_hitPointWorld().z()))),n.Ammo.destroy(r),n.Ammo.destroy(a),n.Ammo.destroy(l),s}rayHitObject(t,e){let s,r=new n.Ammo.btVector3(t.x,t.y,t.z),a=new n.Ammo.btVector3(e.x,e.y,e.z),l=new n.Ammo.ClosestRayResultCallback(r,a);if(this.physicsUniverse.rayTest(r,a,l),l.hasHit()){let c=l.get_m_collisionObject();s=this.objects[c.getUserIndex()]}return n.Ammo.destroy(r),n.Ammo.destroy(a),n.Ammo.destroy(l),s}updateRigidBody(t){this.physicsUniverse.removeRigidBody(t),this.physicsUniverse.addRigidBody(t)}add(t){this.scene.add(t.getMesh()),t.getMesh().children.forEach(e=>this.scene.add(e)),this.objects[String(t.getId())]=t,t.isAffectedByPhysics()&&this.addPhysicsObject(t.getRigidBody())}remove(t){this.scene.remove(t.getMesh()),t.getMesh().children.forEach(e=>this.scene.remove(e)),this.players.forEach(e=>{e.removePotentialChild(String(t.getId()))}),delete this.objects[String(t.getId())],t.isAffectedByPhysics()&&(this.objectCounter--,this.physicsUniverse.removeRigidBody(t.getRigidBody()))}activateAllObjects(){Object.values(this.objects).forEach(t=>{t.isAffectedByPhysics()&&t.getRigidBody().activate()})}addPhysicsObject(t){this.objectCounter++,this.physicsUniverse.addRigidBody(t)}addPlayer(t){this.players.push(t)}}class _t{constructor(){i(this,"_gameAvatarMovementScaling",.7);i(this,"_gameUrl");i(this,"_gameSessionId");i(this,"_tutorialShowItemMs",5e3);i(this,"_gameDurationMs",3e5);i(this,"_gameResetDurationMs",5e3);i(this,"_uiFps",10);i(this,"_uiRefreshMs",1e3/this.uiFps);i(this,"_uiPopupDurationMs",2e3);i(this,"_gameMutablePayloadProbability",.2);i(this,"_gameCooldownMs",2e3);i(this,"_bedrockDepth",-20);i(this,"_bedrockFriction",3);i(this,"_bedrockGridSegments",15);i(this,"_bedrockMass",300);i(this,"_bedrockSize",150);i(this,"_bedrockSpringDamping",.1);i(this,"_bedrockSpringDistanceToCorner",5);i(this,"_bedrockSpringStiffness",500);i(this,"_boxFriction",.7);i(this,"_boxMass",7);i(this,"_boxSize",5);i(this,"_cameraFarPlane",1e4);i(this,"_cameraFov",70);i(this,"_cameraNearPlane",1);i(this,"_cameraX",0);i(this,"_cameraY",40);i(this,"_cameraZ",150);i(this,"_difficulty","medium");i(this,"_highscoreRadius",5);i(this,"_highscoreHeight",10);i(this,"_orbColor",65280);i(this,"_orbFrequency",.003);i(this,"_orbFriction",0);i(this,"_orbMass",0);i(this,"_orbSegments",20);i(this,"_orbSize",3);i(this,"_gameMutablePayloadColor",65280);i(this,"_gameImmutablePayloadColor",16711680);i(this,"_physicsEarthquakeStrength",100);i(this,"_physicsGravity",-10);i(this,"_physicsEngineSubsteps",10);i(this,"_gamePlayerAnimationDurationMs",100);i(this,"_gamePlayerIndicatorOffset",10);i(this,"_gamePlayerMaxHeight",1e3);i(this,"_gamePlayerMinHeight",-100);i(this,"_gamePlayerOffset",10);i(this,"_rayFriction",0);i(this,"_rayMass",0);i(this,"_raySize",this.gamePlayerOffset+this.gamePlayerIndicatorOffset);i(this,"_rendererBackgroundColor",12578030);i(this,"_rendererWindowSpacing",0);i(this,"_rendererMainLightColor",16777215);i(this,"_rendererMainLightIntensity",4.5);i(this,"_rendererMainLightX",0);i(this,"_rendererMainLightY",500);i(this,"_rendererMainLightZ",0);i(this,"_rendererMainLightAngle",Math.PI*.2);i(this,"_rendererMainLightDecay",0);i(this,"_rendererMainLightCastShadows",!0);i(this,"_rendererMainLightShadowNearPlane",.5);i(this,"_rendererMainLightShadowFarPlane",600);i(this,"_rendererMainLightShadowBias",-222e-6);i(this,"_rendererMainLightShadowResolution",2048);i(this,"_gameStartColors",[10294913,16770304,45755,0]);i(this,"_gameStartPositions",[[-50,50],[50,50],[-25,50],[25,50]]);i(this,"_gameMaxPlayers",this.gameStartPositions.length);i(this,"_gameRotationAmount",Math.PI);i(this,"_gameRotationDurationMs",1e3);const t=new URLSearchParams(window.location.search);let e=t.get("session");e!==null?this._gameSessionId=e:(window.localStorage.clear(),this._gameSessionId=btoa(new Date().getTime().toString()).slice(-9).substring(0,7),t.set("session",this.gameSessionId),window.history.replaceState(null,"",`?${t.toString()}`)),this._gameUrl=`${window.location.origin}${window.location.pathname}/controller?session=${this.gameSessionId}`}get gameAvatarMovementScaling(){return this._gameAvatarMovementScaling}get gameUrl(){return this._gameUrl}get gameSessionId(){return this._gameSessionId}get tutorialShowItemMs(){return this._tutorialShowItemMs}get gameDurationMs(){return this._gameDurationMs}get resetDurationMs(){return this._gameResetDurationMs}get uiFps(){return this._uiFps}get uiRefreshMs(){return this._uiRefreshMs}get uiPopupDurationMs(){return this._uiPopupDurationMs}get gameMutablePayloadProbability(){return this._gameMutablePayloadProbability}get gameCooldownMs(){return this._gameCooldownMs}get bedrockDepth(){return this._bedrockDepth}get bedrockFriction(){return this._bedrockFriction}get bedrockGridSegments(){return this._bedrockGridSegments}get bedrockMass(){return this._bedrockMass}get bedrockSize(){return this._bedrockSize}get bedrockSpringDamping(){return this._bedrockSpringDamping}get bedrockSpringDistanceToCorner(){return this._bedrockSpringDistanceToCorner}get bedrockSpringStiffness(){return this._bedrockSpringStiffness}get boxFriction(){return this._boxFriction}get boxMass(){return this._boxMass}get boxSize(){return this._boxSize}get cameraFarPlane(){return this._cameraFarPlane}get cameraFov(){return this._cameraFov}get cameraNearPlane(){return this._cameraNearPlane}get cameraPosition(){return new u(this._cameraX,this._cameraY,this._cameraZ)}get difficulty(){return this._difficulty}get highscoreRadius(){return this._highscoreRadius}get highscoreHeight(){return this._highscoreHeight}get orbColor(){return this._orbColor}get orbFrequency(){return this._orbFrequency}get orbFriction(){return this._orbFriction}get orbMass(){return this._orbMass}get orbSegments(){return this._orbSegments}get orbSize(){return this._orbSize}get gameMutablePayloadColor(){return this._gameMutablePayloadColor}get gameImmutablePayloadColor(){return this._gameImmutablePayloadColor}get physicsEarthquakeStrength(){return this._physicsEarthquakeStrength}get physicsGravity(){return this._physicsGravity}get physicsEngineSubsteps(){return this._physicsEngineSubsteps}get gamePlayerAnimationDurationMs(){return this._gamePlayerAnimationDurationMs}get gamePlayerIndicatorOffset(){return this._gamePlayerIndicatorOffset}get gamePlayerMaxHeight(){return this._gamePlayerMaxHeight}get gamePlayerMinHeight(){return this._gamePlayerMinHeight}get gamePlayerOffset(){return this._gamePlayerOffset}get rayFriction(){return this._rayFriction}get rayMass(){return this._rayMass}get raySize(){return this._raySize}get rendererBackgroundColor(){return this._rendererBackgroundColor}get rendererWindowSpacing(){return this._rendererWindowSpacing}get rendererMainLightColor(){return this._rendererMainLightColor}get rendererMainLightIntensity(){return this._rendererMainLightIntensity}get rendererMainLightPosition(){return new u(this._rendererMainLightX,this._rendererMainLightY,this._rendererMainLightZ)}get rendererMainLightAngle(){return this._rendererMainLightAngle}get rendererMainLightDecay(){return this._rendererMainLightDecay}get rendererMainLightCastShadows(){return this._rendererMainLightCastShadows}get rendererMainLightShadowNearPlane(){return this._rendererMainLightShadowNearPlane}get rendererMainLightShadowFarPlane(){return this._rendererMainLightShadowFarPlane}get rendererMainLightShadowBias(){return this._rendererMainLightShadowBias}get rendererMainLightShadowResolution(){return this._rendererMainLightShadowResolution}get gameStartColors(){return this._gameStartColors}get gameStartPositions(){return this._gameStartPositions}get gameMaxPlayers(){return this._gameMaxPlayers}get gameRotationAmount(){return this._gameRotationAmount}get gameRotationDurationMs(){return this._gameRotationDurationMs}storeInLocalStorage(){window.localStorage.setItem("config",JSON.stringify(this))}loadFromLocalStorage(){let t=window.localStorage.getItem("config");if(t===null)return;let e=this,s=JSON.parse(t);Object.keys(e).forEach(r=>{r.startsWith("_")&&s[r]!==null&&(e[r]=s[r])})}setGameDuration(t){t<=0||(this._gameDurationMs=t,this.storeInLocalStorage())}setEasyDifficulty(){this._difficulty="easy",this._bedrockMass=300,this._boxMass=10,this._boxFriction=.4,this.storeInLocalStorage()}setMediumDifficulty(){this._difficulty="medium",this._bedrockMass=300,this._boxMass=7,this._boxFriction=.7,this.storeInLocalStorage()}setHardDifficulty(){this._difficulty="hard",this._bedrockMass=100,this._boxMass=1,this._boxFriction=.9,this.storeInLocalStorage()}}const Qt="8884/mqtt",Jt="wss",Kt="broker.hivemq.com";let y;(async()=>(n.Ammo=await tt.bind(window)(),n.initAuxObjects(),te()))();function te(){const o=new _t;o.loadFromLocalStorage();const t=new ht(ct.connect(`${Jt}://${Kt}:${Qt}`),!1,o.gameSessionId);y=new Q((c,w,f,M,v)=>new G(new u(c,w,f),M,v),r,a,()=>new Zt(o),o),t.subscribe(t.eventToTopic(A.PlayerAction,b.All)),e(),t.on("message",(c,w)=>{const f=w.toString(),[M,v,g]=t.parseTopic(c);switch(v){case b.Init:{if(g!=""&&y.isPlayerAddable()){let k=y.addPlayer(g,f).toString(16);for(;k.length<6;)k=`0${k}`;t.publishClientSpecific(A.ControllerMessage,b.ColorResponse,g,`#${k}`),y.isRunning()&&t.publishClientSpecific(A.ControllerMessage,b.Start,g,"")}else t.publishClientSpecific(A.ControllerMessage,b.GameFullResponse,g,"");break}case b.XMovement:{y.hasPlayer(g)&&y.getPlayer(g).translateX(parseFloat(f)*o.gameAvatarMovementScaling);break}case b.YMovement:break;case b.ZMovement:{y.hasPlayer(g)&&y.getPlayer(g).translateZ(parseFloat(f)*o.gameAvatarMovementScaling);break}case b.Movement:{if(y.hasPlayer(g)){const[I,k,at]=lt(f);y.getPlayer(g).translateX(I*o.gameAvatarMovementScaling),y.getPlayer(g).translateZ(at*o.gameAvatarMovementScaling)}break}case b.Drop:{y.activatePayload(g);break}case b.Scale:{y.scalePlayer(g,parseFloat(f));break}case b.ColorResponse:break;case b.Start:{y.start(),t.publishClientSpecific(A.ControllerMessage,b.Start,t.broadcast,"");break}case b.RotatePayload:{y.switchPlayerPayload(g,parseInt(f));break}case b.Reset:{y.isRunning()||(y.reset(),t.publishClientSpecific(A.ControllerMessage,b.Reset,t.broadcast,""));break}default:console.warn(`topic ${c} undefined`)}});function e(){document.body.addEventListener("keydown",c=>{switch(c.key){case"3":o.setHardDifficulty(),r(),a(),window.location.reload();break;case"2":o.setMediumDifficulty(),r(),a(),window.location.reload();break;case"1":o.setEasyDifficulty(),r(),a(),window.location.reload();break;case"+":o.setGameDuration(o.gameDurationMs+6e4),a(),a(),window.location.reload();break;case"-":o.setGameDuration(o.gameDurationMs-6e4),a(),a(),window.location.reload();break}})}function s(){document.body.addEventListener("keydown",c=>{switch(c.key){case"ArrowLeft":y.triggerHealtCheck();break;case"ArrowRight":o.setEasyDifficulty(),r(),a(),window.location.reload();break;case"ArrowUp":o.setHardDifficulty(),r(),a(),window.location.reload();break}})}function r(){t.publishClientSpecific(A.ControllerMessage,b.Stop,t.broadcast,"")}function a(){t.publishClientSpecific(A.ControllerMessage,b.Reset,t.broadcast,"")}function l(){requestAnimationFrame(l),y.update(),y.render()}s(),l()}
